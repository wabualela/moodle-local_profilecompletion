# local_profilecompletion — Profile Completion Prompt

A Moodle local plugin that prompts users to fill in missing profile fields immediately after login, using an inline page notification and a modal form — no page redirect required.

**License:** [GNU GPL v3 or later](https://www.gnu.org/copyleft/gpl.html)
**Requires:** Moodle 4.5+ (build 2024100700)
**Release:** 0.1 Alpha

---

## How it works

```
User logs in
     │
     ▼
observer::user_loggedin()
  ├─ Plugin disabled?  ──► skip
  ├─ Guest user?       ──► skip
  ├─ No missing fields? ──► clear flag, skip
  └─ Missing fields found ──► SESSION flag = pending
              │
              ▼
Next page load (any page)
hook_callbacks::show_missing_fields_prompt()
  ├─ Not logged in / guest / login page / CLI / AJAX? ──► skip
  ├─ No missing fields left? ──► clear flag, skip
  └─ Render hidden <div> at top of <body> via add_html()
     + load AMD module local_profilecompletion/prompt
              │
              ▼
AMD: prompt.js init()
  ├─ Find notification element (data-region selector)
  ├─ Move it into #page-content / #region-main / [data-region="main-content"]
  └─ Show it (remove display:none)
              │
              ▼
User clicks "Fill missing fields"
  └─ ModalForm opens (core_form/modalform)
       └─ missing_fields_form (dynamic_form)
            ├─ Renders only the fields that are actually missing
            ├─ Validates server-side + client-side
            └─ Saves via user_update_user() + profile_save_data()
                   │
                   ▼
             Page reloads — notification is gone
```

### Key design decisions

- **Session flag** — missing-field detection runs once at login (`user_loggedin` event) and stores a lightweight boolean in `$SESSION`. Every subsequent page load only re-checks if the flag is set, keeping overhead minimal.
- **Hidden injection** — the notification HTML is injected hidden at the top of `<body>` by the Moodle hook, then the AMD module moves it into the real content area and makes it visible. This avoids layout flash and works across themes.
- **No page redirect** — the entire flow happens in a modal; users never leave the page they were on.
- **Dynamic form** — only the fields that are _actually missing_ for the current user appear in the modal. Nothing is shown twice once saved.

---

## What the plugin fixes

### Bug: `phone1` field silently dropped from configured field list

Moodle's `phone1` field contains a digit. The original field-key validation regex was `/^core:([a-z_]+)$/` — the character class `[a-z_]` excludes digits, so `core:phone1` always failed validation and was silently discarded after being saved in the admin settings.

**Fix** (`classes/helper.php`): changed regex to `/^core:([a-z0-9_]+)$/`, matching the pattern already used for `custom:` field keys. A dedicated regression test (`tests/helper_test.php::test_phone1_fieldkey_is_valid_and_detected_as_missing`) was added to prevent regressions.

---

## Supported profile fields

### Core user fields

| Key | Field |
|-----|-------|
| `core:firstname` | First name |
| `core:lastname` | Last name |
| `core:email` | Email address |
| `core:city` | City / town |
| `core:country` | Country |
| `core:phone1` | Phone number |

### Custom profile fields

Any custom profile field created in **Site administration → Users → User profile fields** is available as `custom:<shortname>`. The plugin reads all existing custom fields dynamically — no code changes are needed when new fields are added.

---

## Installation

### 1. Copy the plugin directory

Place the plugin folder inside your Moodle `local/` directory so the path is:

```
{moodle_root}/local/profilecompletion/
```

### 2. Run the Moodle upgrade

Visit your Moodle site as an administrator:

```
Site administration → Notifications
```

Click **Upgrade Moodle database now**. The plugin registers itself — no database tables are created.

Alternatively, run the CLI upgrade:

```bash
php admin/cli/upgrade.php
```

### 3. Configure the plugin

Go to **Site administration → Local plugins → Profile completion prompt**.

| Setting | Description |
|---------|-------------|
| **Enable** | Turn the plugin on or off globally. Defaults to enabled. |
| **Fields to enforce** | Multi-select list of core and custom profile fields. Only the selected fields will be checked and prompted. |

---

## File structure

```
local/profilecompletion/
├── amd/
│   ├── build/
│   │   ├── prompt.min.js          # Compiled AMD module (generated by grunt)
│   │   └── prompt.min.js.map
│   └── src/
│       └── prompt.js              # Source: moves notification into content area,
│                                  #         opens ModalForm on button click
├── classes/
│   ├── form/
│   │   └── missing_fields_form.php  # Dynamic modal form — renders, validates, saves
│   ├── helper.php                   # Core logic: field discovery, session flag, validation
│   ├── hook_callbacks.php           # Injects hidden notification + loads AMD on each page
│   └── observer.php                 # Login event: sets session flag if fields are missing
├── db/
│   ├── events.php                   # Registers user_loggedin observer
│   └── hooks.php                    # Registers before_standard_top_of_body_html_generation hook
├── lang/
│   └── en/
│       └── local_profilecompletion.php  # English strings
├── templates/
│   └── notification.mustache        # Inline alert markup (hidden until JS shows it)
├── tests/
│   ├── behat/
│   │   └── prompt.feature           # Browser acceptance tests
│   └── helper_test.php              # PHPUnit tests for helper logic
├── settings.php                     # Admin settings page
└── version.php                      # Plugin version and requirements
```

---

## Development

### Requirements

- Moodle 4.5 or later
- Node.js and npm (for AMD build)
- Grunt CLI

### Rebuild AMD JavaScript

After modifying `amd/src/prompt.js`, rebuild the minified file from the Moodle root:

```bash
cd {moodle_root}
node_modules/.bin/grunt amd --root=local/profilecompletion
```

### Run PHPUnit tests

```bash
cd {moodle_root}
php admin/tool/phpunit/cli/init.php
vendor/bin/phpunit --testsuite local_profilecompletion_testsuite
```

### Run Behat tests

```bash
cd {moodle_root}
php admin/tool/behat/cli/init.php
vendor/bin/behat --config {moodle_dataroot}/behat/behat.yml \
  --tags @local_profilecompletion
```

---

## Contributing

Contributions are welcome. Please:

1. Fork the repository and create a feature branch.
2. Follow [Moodle coding style](https://moodledev.io/general/development/policies/codingstyle).
3. Add or update tests for any changed behaviour.
4. Open a pull request with a clear description of the change.

Bug reports and feature requests can be filed as GitHub issues.

---

## License

This plugin is free software: you can redistribute it and/or modify it under the terms of the **GNU General Public License** as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the [GNU General Public License](https://www.gnu.org/licenses/) for more details.

Copyright 2026 [Moddaker](https://moddaker.com)
